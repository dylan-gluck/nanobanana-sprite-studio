// Prisma schema for megabananas
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AssetType {
  reference
  character
  frame
  spritesheet
}

// Top-level container for all work
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  thumbnailId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  assets       Asset[]
  characters   Character[]
  animations   Animation[]
  spriteSheets SpriteSheet[]

  @@index([name])
}

// Unified storage for all images with provenance tracking
model Asset {
  id        String    @id @default(cuid())
  projectId String
  filePath  String
  type      AssetType @default(character)
  createdAt DateTime  @default(now())

  // Provenance fields
  systemPrompt      String?
  userPrompt        String?
  referenceAssetIds String[] // IDs of assets used as references during generation
  generationSettings Json?   // Model params, dimensions, etc.

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  character Character? @relation("CharacterAssets", fields: [characterId], references: [id], onDelete: SetNull)
  characterId String?

  // Primary asset relation (reverse)
  primaryForCharacter Character? @relation("CharacterPrimaryAsset")

  // Frame relation
  frame Frame?

  // SpriteSheet relation
  spriteSheet SpriteSheet? @relation("SpriteSheetAsset")

  @@index([projectId])
  @@index([characterId])
}

// Character with variations and primary asset
model Character {
  id        String   @id @default(cuid())
  projectId String
  name      String
  userPrompt String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Primary asset reference
  primaryAssetId String? @unique
  primaryAsset   Asset?  @relation("CharacterPrimaryAsset", fields: [primaryAssetId], references: [id], onDelete: SetNull)

  // Relations
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets       Asset[]       @relation("CharacterAssets") // Variation assets
  animations   Animation[]
  spriteSheets SpriteSheet[]

  @@unique([projectId, name])
  @@index([projectId])
}

// Animation sequence belonging to a character
model Animation {
  id          String   @id @default(cuid())
  projectId   String
  characterId String
  name        String
  description String?
  frameCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Generation config (characterAssetId, anglePreset, etc.)
  generationSettings Json?

  // Relations
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  frames    Frame[]

  @@unique([characterId, name])
  @@index([projectId])
  @@index([characterId])
}

// Individual frame in an animation sequence
model Frame {
  id          String   @id @default(cuid())
  animationId String
  assetId     String   @unique
  frameIndex  Int
  createdAt   DateTime @default(now())

  // Relations
  animation Animation @relation(fields: [animationId], references: [id], onDelete: Cascade)
  asset     Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([animationId, frameIndex])
  @@index([animationId])
}

// Sprite sheet containing all animation frames in a grid
model SpriteSheet {
  id          String   @id @default(cuid())
  projectId   String
  characterId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Asset reference (the generated sprite sheet image)
  assetId String @unique
  asset   Asset  @relation("SpriteSheetAsset", fields: [assetId], references: [id], onDelete: Cascade)

  // Generation config (characterAssetId, anglePreset, sequences array)
  generationSettings Json?

  // Relations
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, name])
  @@index([projectId])
  @@index([characterId])
}
